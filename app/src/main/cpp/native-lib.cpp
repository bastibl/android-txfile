#include <jni.h>
#include <string>
#include <iostream>
#include <sstream>

#include <gnuradio/logger.h>
#include <gnuradio/top_block.h>
#include <gnuradio/uhd/usrp_sink.h>
#include <gnuradio/analog/sig_source.h>
#include <gnuradio/blocks/file_source.h>
#include <gnuradio/blocks/multiply.h>
#include <gnuradio/blocks/null_sink.h>
#include <gnuradio/blocks/throttle.h>
#include <gnuradio/filter/rational_resampler_base.h>
#include <stdlib.h>

gr::top_block_sptr tb;

std::vector<gr_complex> taps = {
7.880556222517043e-05,
9.696597408037633e-05,
0.00011510762124089524,
0.0001326514029642567,
0.00014897368964739144,
0.0001634212676435709,
0.00017532821220811456,
0.00018403462308924645,
0.00018890669161919504,
0.00018935742264147848,
0.0001848679530667141,
0.0001750084775267169,
0.00015945822815410793,
0.0001380241010338068,
0.00011065712897107005,
7.746619667159393e-05,
3.872850720654242e-05,
-5.103796866023913e-06,
-5.340118514141068e-05,
-0.00010535900219110772,
-0.00016000460891518742,
-0.00021620940242428333,
-0.00027270615100860596,
-0.00032811102573759854,
-0.0003809504269156605,
-0.00042969227069988847,
-0.0004727804916910827,
-0.0005086736637167633,
-0.0005358850467018783,
-0.0005530243506655097,
-0.0005588404601439834,
-0.0005522628780454397,
-0.0005324417725205421,
-0.0004987855791114271,
-0.0004509940627031028,
-0.00038908678106963634,
-0.0003134252328891307,
-0.00022472807904705405,
-0.00012407873873598874,
-1.292409888264956e-05,
0.00010693548392737284,
0.00023336561571341008,
0.0003639267524704337,
0.0004959122161380947,
0.0006263952236622572,
0.0007522842497564852,
0.0008703857311047614,
0.0009774732170626521,
0.0010703613515943289,
0.0011459840461611748,
0.001201473642140627,
0.001234241179190576,
0.0012420534621924162,
0.00122310861479491,
0.0011761030182242393,
0.001100292894989252,
0.0009955451823771,
0.0008623770554549992,
0.0007019829354248941,
0.0005162470042705536,
0.00030774023616686463,
7.970151636982337e-05,
-0.00016399779997300357,
-0.0004189061000943184,
-0.000680060125887394,
-0.0009420686401426792,
-0.0011992112267762423,
-0.0014455497730523348,
-0.0016750508220866323,
-0.0018817164236679673,
-0.002059722086414695,
-0.0022035574074834585,
-0.0023081672843545675,
-0.002369089052081108,
-0.002382585546001792,
-0.0023457666393369436,
-0.0022566986735910177,
-0.0021144975908100605,
-0.00191940285731107,
-0.001672831829637289,
-0.0013774065300822258,
-0.0010369584197178483,
-0.0006565033691003919,
-0.00024219143961090595,
0.00019877363229170442,
0.0006582406931556761,
0.001127244788222015,
0.0015961650060489774,
0.0020549041219055653,
0.0024930883664637804,
0.002900282619521022,
0.0032662157900631428,
0.003581015160307288,
0.003835441777482629,
0.004021122120320797,
0.0041307732462882996,
0.004158413037657738,
0.004099550656974316,
0.003951353020966053,
0.0037127842660993338,
0.0033847109880298376,
0.0029699676670134068,
0.0024733864702284336,
0.0019017800223082304,
0.001263884361833334,
0.0005702532944269478,
-0.00016688914911355823,
-0.0009338396484963596,
-0.00171564775519073,
-0.0024963845498859882,
-0.003259444609284401,
-0.003987875301390886,
-0.004664727486670017,
-0.005273422226309776,
-0.005798121448606253,
-0.0062241037376224995,
-0.006538125686347485,
-0.00672876974567771,
-0.006786765065044165,
-0.0067052775993943214,
-0.0064801559783518314,
-0.006110130809247494,
-0.005596961826086044,
-0.004945522639900446,
-0.004163824021816254,
-0.003262966638430953,
-0.0022570332512259483,
-0.0011629014043137431,
9.279470930297475e-18,
0.0012100074673071504,
0.002443594392389059,
0.003675801446661353,
0.004880708176642656,
0.006031950935721397,
0.007103264797478914,
0.008069047704339027,
0.008904926478862762,
0.009588325396180153,
0.010099015198647976,
0.010419624857604504,
0.010536125861108303,
0.010438255034387112,
0.010119869373738766,
0.009579233825206757,
0.008819224312901497,
0.007847435772418976,
0.006676199845969677,
0.005322491750121117,
0.003807754721492529,
0.0021576001308858395,
0.00040142660145647824,
-0.001428065006621182,
-0.003295441158115864,
-0.005163182038813829,
-0.006992397364228964,
-0.008743596263229847,
-0.010377496480941772,
-0.011855856515467167,
-0.013142316602170467,
-0.014203234575688839,
-0.015008477494120598,
-0.015532192774116993,
-0.01575348526239395,
-0.01565703935921192,
-0.015233633108437061,
-0.014480537734925747,
-0.013401811011135578,
-0.012008431367576122,
-0.010318320244550705,
-0.008356204256415367,
-0.006153321824967861,
-0.0037470015231519938,
-0.0011800891952589154,
0.0014997624093666673,
0.004240923095494509,
0.006988729350268841,
0.00968652032315731,
0.012276753783226013,
0.01470217201858759,
0.01690700836479664,
0.018838198855519295,
0.020446570590138435,
0.02168799377977848,
0.022524474188685417,
0.02292514406144619,
0.02286713384091854,
0.022336306050419807,
0.02132786251604557,
0.019846713170409203,
0.01790771447122097,
0.015535690821707249,
0.012765228748321533,
0.009640296921133995,
0.006213622633367777,
0.0025459027383476496,
-0.001295206369832158,
-0.0052362545393407345,
-0.00919933058321476,
-0.013103530742228031,
-0.016866527497768402,
-0.020406223833560944,
-0.023642461746931076,
-0.02649872377514839,
-0.028903840109705925,
-0.030793622136116028,
-0.032112397253513336,
-0.032814450562000275,
-0.032865263521671295,
-0.03224259614944458,
-0.030937308445572853,
-0.028954019770026207,
-0.026311401277780533,
-0.023042267188429832,
-0.019193345680832863,
-0.014824779704213142,
-0.010009298101067543,
-0.004831147845834494,
0.0006152692949399352,
0.006227004341781139,
0.011894390918314457,
0.017503071576356888,
0.02293618768453598,
0.028076674789190292,
0.03280964866280556,
0.03702482208609581,
0.0406189002096653,
0.04349788278341293,
0.04557931795716286,
0.04679430276155472,
0.04708936810493469,
0.04642802104353905,
0.0447920523583889,
0.042182501405477524,
0.0386202447116375,
0.03414623811841011,
0.0288213063031435,
0.022725604474544525,
0.01595759578049183,
0.00863268505781889,
0.0008814402972348034,
-0.007152540609240532,
-0.01531508844345808,
-0.02344420552253723,
-0.031373072415590286,
-0.038933224976062775,
-0.04595788195729256,
-0.052285343408584595,
-0.05776238441467285,
-0.0622476190328598,
-0.065614715218544,
-0.06775543093681335,
-0.06858236342668533,
-0.068031445145607,
-0.06606399267911911,
-0.0626683384180069,
-0.057861048728227615,
-0.051687534898519516,
-0.04422221705317497,
-0.035568032413721085,
-0.025855479761958122,
-0.015240989625453949,
-0.003904828568920493,
0.007951578125357628,
0.020108811557292938,
0.032333068549633026,
0.044380173087120056,
0.05599992722272873,
0.06694073975086212,
0.07695439457893372,
0.08580098301172256,
0.09325379878282547,
0.09910418838262558,
0.10316624492406845,
0.10528121888637543,
0.10532153397798538,
0.10319453477859497,
0.09884551167488098,
0.09226036071777344,
0.08346739411354065,
0.07253863662481308,
0.059590257704257965,
0.04478231444954872,
0.028317654505372047,
0.010440101847052574,
-0.008568190038204193,
-0.028390100225806236,
-0.04867761954665184,
-0.06905657798051834,
-0.08913198858499527,
-0.1084938496351242,
-0.12672342360019684,
-0.14339986443519592,
-0.1581069529056549,
-0.17044012248516083,
-0.18001332879066467,
-0.18646585941314697,
-0.18946893513202667,
-0.18873193860054016,
-0.18400822579860687,
-0.17510028183460236,
-0.16186420619487762,
-0.14421364665031433,
-0.12212271243333817,
-0.09562800824642181,
-0.06482981145381927,
-0.029892243444919586,
0.00895755272358656,
0.05143125727772713,
0.09718214720487595,
0.1458088904619217,
0.19686010479927063,
0.24984000623226166,
0.3042145073413849,
0.35941824316978455,
0.4148620367050171,
0.4699409008026123,
0.5240422487258911,
0.5765544176101685,
0.6268754005432129,
0.6744211912155151,
0.7186340689659119,
0.7589909434318542,
0.7950103878974915,
0.8262600302696228,
0.8523626923561096,
0.8730020523071289,
0.8879270553588867,
0.8969556093215942,
0.8999775052070618,
0.8969556093215942,
0.8879270553588867,
0.8730020523071289,
0.8523626923561096,
0.8262600302696228,
0.7950103878974915,
0.7589909434318542,
0.7186340689659119,
0.6744211912155151,
0.6268754005432129,
0.5765544176101685,
0.5240422487258911,
0.4699409008026123,
0.4148620367050171,
0.35941824316978455,
0.3042145073413849,
0.24984000623226166,
0.19686010479927063,
0.1458088904619217,
0.09718214720487595,
0.05143125727772713,
0.00895755272358656,
-0.029892243444919586,
-0.06482981145381927,
-0.09562800824642181,
-0.12212271243333817,
-0.14421364665031433,
-0.16186420619487762,
-0.17510028183460236,
-0.18400822579860687,
-0.18873193860054016,
-0.18946893513202667,
-0.18646585941314697,
-0.18001332879066467,
-0.17044012248516083,
-0.1581069529056549,
-0.14339986443519592,
-0.12672342360019684,
-0.1084938496351242,
-0.08913198858499527,
-0.06905657798051834,
-0.04867761954665184,
-0.028390100225806236,
-0.008568190038204193,
0.010440101847052574,
0.028317654505372047,
0.04478231444954872,
0.059590257704257965,
0.07253863662481308,
0.08346739411354065,
0.09226036071777344,
0.09884551167488098,
0.10319453477859497,
0.10532153397798538,
0.10528121888637543,
0.10316624492406845,
0.09910418838262558,
0.09325379878282547,
0.08580098301172256,
0.07695439457893372,
0.06694073975086212,
0.05599992722272873,
0.044380173087120056,
0.032333068549633026,
0.020108811557292938,
0.007951578125357628,
-0.003904828568920493,
-0.015240989625453949,
-0.025855479761958122,
-0.035568032413721085,
-0.04422221705317497,
-0.051687534898519516,
-0.057861048728227615,
-0.0626683384180069,
-0.06606399267911911,
-0.068031445145607,
-0.06858236342668533,
-0.06775543093681335,
-0.065614715218544,
-0.0622476190328598,
-0.05776238441467285,
-0.052285343408584595,
-0.04595788195729256,
-0.038933224976062775,
-0.031373072415590286,
-0.02344420552253723,
-0.01531508844345808,
-0.007152540609240532,
0.0008814402972348034,
0.00863268505781889,
0.01595759578049183,
0.022725604474544525,
0.0288213063031435,
0.03414623811841011,
0.0386202447116375,
0.042182501405477524,
0.0447920523583889,
0.04642802104353905,
0.04708936810493469,
0.04679430276155472,
0.04557931795716286,
0.04349788278341293,
0.0406189002096653,
0.03702482208609581,
0.03280964866280556,
0.028076674789190292,
0.02293618768453598,
0.017503071576356888,
0.011894390918314457,
0.006227004341781139,
0.0006152692949399352,
-0.004831147845834494,
-0.010009298101067543,
-0.014824779704213142,
-0.019193345680832863,
-0.023042267188429832,
-0.026311401277780533,
-0.028954019770026207,
-0.030937308445572853,
-0.03224259614944458,
-0.032865263521671295,
-0.032814450562000275,
-0.032112397253513336,
-0.030793622136116028,
-0.028903840109705925,
-0.02649872377514839,
-0.023642461746931076,
-0.020406223833560944,
-0.016866527497768402,
-0.013103530742228031,
-0.00919933058321476,
-0.0052362545393407345,
-0.001295206369832158,
0.0025459027383476496,
0.006213622633367777,
0.009640296921133995,
0.012765228748321533,
0.015535690821707249,
0.01790771447122097,
0.019846713170409203,
0.02132786251604557,
0.022336306050419807,
0.02286713384091854,
0.02292514406144619,
0.022524474188685417,
0.02168799377977848,
0.020446570590138435,
0.018838198855519295,
0.01690700836479664,
0.01470217201858759,
0.012276753783226013,
0.00968652032315731,
0.006988729350268841,
0.004240923095494509,
0.0014997624093666673,
-0.0011800891952589154,
-0.0037470015231519938,
-0.006153321824967861,
-0.008356204256415367,
-0.010318320244550705,
-0.012008431367576122,
-0.013401811011135578,
-0.014480537734925747,
-0.015233633108437061,
-0.01565703935921192,
-0.01575348526239395,
-0.015532192774116993,
-0.015008477494120598,
-0.014203234575688839,
-0.013142316602170467,
-0.011855856515467167,
-0.010377496480941772,
-0.008743596263229847,
-0.006992397364228964,
-0.005163182038813829,
-0.003295441158115864,
-0.001428065006621182,
0.00040142660145647824,
0.0021576001308858395,
0.003807754721492529,
0.005322491750121117,
0.006676199845969677,
0.007847435772418976,
0.008819224312901497,
0.009579233825206757,
0.010119869373738766,
0.010438255034387112,
0.010536125861108303,
0.010419624857604504,
0.010099015198647976,
0.009588325396180153,
0.008904926478862762,
0.008069047704339027,
0.007103264797478914,
0.006031950935721397,
0.004880708176642656,
0.003675801446661353,
0.002443594392389059,
0.0012100074673071504,
9.279470930297475e-18,
-0.0011629014043137431,
-0.0022570332512259483,
-0.003262966638430953,
-0.004163824021816254,
-0.004945522639900446,
-0.005596961826086044,
-0.006110130809247494,
-0.0064801559783518314,
-0.0067052775993943214,
-0.006786765065044165,
-0.00672876974567771,
-0.006538125686347485,
-0.0062241037376224995,
-0.005798121448606253,
-0.005273422226309776,
-0.004664727486670017,
-0.003987875301390886,
-0.003259444609284401,
-0.0024963845498859882,
-0.00171564775519073,
-0.0009338396484963596,
-0.00016688914911355823,
0.0005702532944269478,
0.001263884361833334,
0.0019017800223082304,
0.0024733864702284336,
0.0029699676670134068,
0.0033847109880298376,
0.0037127842660993338,
0.003951353020966053,
0.004099550656974316,
0.004158413037657738,
0.0041307732462882996,
0.004021122120320797,
0.003835441777482629,
0.003581015160307288,
0.0032662157900631428,
0.002900282619521022,
0.0024930883664637804,
0.0020549041219055653,
0.0015961650060489774,
0.001127244788222015,
0.0006582406931556761,
0.00019877363229170442,
-0.00024219143961090595,
-0.0006565033691003919,
-0.0010369584197178483,
-0.0013774065300822258,
-0.001672831829637289,
-0.00191940285731107,
-0.0021144975908100605,
-0.0022566986735910177,
-0.0023457666393369436,
-0.002382585546001792,
-0.002369089052081108,
-0.0023081672843545675,
-0.0022035574074834585,
-0.002059722086414695,
-0.0018817164236679673,
-0.0016750508220866323,
-0.0014455497730523348,
-0.0011992112267762423,
-0.0009420686401426792,
-0.000680060125887394,
-0.0004189061000943184,
-0.00016399779997300357,
7.970151636982337e-05,
0.00030774023616686463,
0.0005162470042705536,
0.0007019829354248941,
0.0008623770554549992,
0.0009955451823771,
0.001100292894989252,
0.0011761030182242393,
0.00122310861479491,
0.0012420534621924162,
0.001234241179190576,
0.001201473642140627,
0.0011459840461611748,
0.0010703613515943289,
0.0009774732170626521,
0.0008703857311047614,
0.0007522842497564852,
0.0006263952236622572,
0.0004959122161380947,
0.0003639267524704337,
0.00023336561571341008,
0.00010693548392737284,
-1.292409888264956e-05,
-0.00012407873873598874,
-0.00022472807904705405,
-0.0003134252328891307,
-0.00038908678106963634,
-0.0004509940627031028,
-0.0004987855791114271,
-0.0005324417725205421,
-0.0005522628780454397,
-0.0005588404601439834,
-0.0005530243506655097,
-0.0005358850467018783,
-0.0005086736637167633,
-0.0004727804916910827,
-0.00042969227069988847,
-0.0003809504269156605,
-0.00032811102573759854,
-0.00027270615100860596,
-0.00021620940242428333,
-0.00016000460891518742,
-0.00010535900219110772,
-5.340118514141068e-05,
-5.103796866023913e-06,
3.872850720654242e-05,
7.746619667159393e-05,
0.00011065712897107005,
0.0001380241010338068,
0.00015945822815410793,
0.0001750084775267169,
0.0001848679530667141,
0.00018935742264147848,
0.00018890669161919504,
0.00018403462308924645,
0.00017532821220811456,
0.0001634212676435709,
0.00014897368964739144,
0.0001326514029642567,
0.00011510762124089524,
9.696597408037633e-05,
7.880556222517043e-05
};

extern "C"
JNIEXPORT jobject JNICALL
Java_net_bastibl_txfile_MainActivity_fgInit(JNIEnv * env, jobject /*this*/, int fd, jstring usbfsPath, jstring sampleFile) {
    if(tb) {
        GR_INFO("gr", "Stopping flowgraph");
        tb->stop();
        tb->wait();
        tb = nullptr;
    }

    const char *usbfs_path = env->GetStringUTFChars(usbfsPath, NULL);
    const char *sample_file = env->GetStringUTFChars(sampleFile, NULL);

    tb = gr::make_top_block("txfile");

    std::stringstream args;
    args << "bbl=foo,type=b200,fd=" << fd << ",usbfs_path=" << usbfs_path;
    GR_INFO("fg", boost::str(boost::format("Using UHD args=%1%") % args.str()));

    ::uhd::stream_args_t stream_args;
    stream_args.cpu_format = "fc32";
    stream_args.otw_format = "sc16";

    double sample_rate = 1e6;
    int interpolation_factor = 20;
    int LO_offset = int(100e3);
    double center_frequency = 500e6;

    gr::uhd::usrp_sink::sptr snk = gr::uhd::usrp_sink::make(args.str(), stream_args);
    snk->set_samp_rate(sample_rate);
    snk->set_center_freq(center_frequency, 0);
    snk->set_normalized_gain(0.3);
    //gr::blocks::null_sink::sptr snk = gr::blocks::null_sink::make(sizeof(gr_complex));
    gr::filter::rational_resampler_base_ccc::sptr rational_resampler = gr::filter::rational_resampler_base_ccc::make(interpolation_factor, 1, taps);
    //gr::blocks::throttle::sptr throttle = gr::blocks::throttle::make(sizeof(gr_complex), 1e6, true);
    gr::blocks::multiply_cc::sptr multiply = gr::blocks::multiply_cc::make(1);
    gr::blocks::file_source::sptr file_source = gr::blocks::file_source::make(sizeof(gr_complex), sample_file, true, 0, 0);
    gr::analog::sig_source_c::sptr sig_source = gr::analog::sig_source_c::make(sample_rate, gr::analog::GR_COS_WAVE, LO_offset, .7, 0,0);

    tb->connect(file_source, 0, rational_resampler, 0);
    tb->connect(rational_resampler, 0, multiply, 0);
    tb->connect(sig_source, 0, multiply, 1);
    tb->connect(multiply, 0, snk, 0);

    return nullptr;
}

extern "C"
JNIEXPORT jobject JNICALL
Java_net_bastibl_txfile_MainActivity_fgStart(JNIEnv * env, jobject /*this*/, jstring tmpDir) {

    const char *tmp_c;
    tmp_c = env->GetStringUTFChars(tmpDir, nullptr);
    setenv("TMP", tmp_c, 1);

    GR_INFO("gr", "external storage");
    GR_INFO("gr", getenv("EXTERNAL_STORAGE"));
    setenv("VOLK_CONFIGPATH", getenv("EXTERNAL_STORAGE"), 1);

    GR_INFO("gr", "starting flowgraph");
    tb->start();
    //sleep(30);
    GR_INFO("gr", "started flowgraph");
    return nullptr;
}

extern "C"
JNIEXPORT jobject JNICALL
Java_net_bastibl_txfile_MainActivity_fgStop(JNIEnv * env, jobject /*this*/) {
    if(tb) {
        GR_DEBUG("gr", "Stopping flowgraph");
        tb->stop();
        tb->wait();
        tb = nullptr;
    } else {
        GR_DEBUG("gr", "Flowgraph not running, nothing to stop.");
    }
    return nullptr;
}